<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    input, textarea, button { margin: 5px 0; padding: 8px; width: 300px; }
    .event-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #fff; border-radius: 6px; }
    button { cursor: pointer; border: none; border-radius: 4px; background: #007bff; color: white; padding: 6px 12px; margin-right: 5px; }
    button:hover { background: #0056b3; }
    .loading { font-style: italic; color: #555; }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>
  <button onclick="logout()">Logout</button>

  <h2 id="form-title">Create Event</h2>
  <form id="eventForm">
    <input type="text" id="title" placeholder="Title" required />
    <textarea id="description" placeholder="Description"></textarea>
    <input type="date" id="date" required />
    <input type="time" id="time" required />
    <input type="text" id="location" placeholder="Location" required />
    <button type="submit" id="submitBtn">Create Event</button>
    <button type="button" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
  </form>

  <h2>All Events</h2>
  <div id="events" class="loading">Loading events...</div>

<script>
const API = "http://localhost:5001/api";
const token = localStorage.getItem("token");
if(!token) window.location = "index.html";

let editingEventId = null;

async function loadEvents() {
  const container = document.getElementById("events");
  container.innerHTML = '<p class="loading">Loading events...</p>';

  try {
    const eventsRes = await fetch(`${API}/events/`, { headers: { Authorization: `Bearer ${token}` } });
    if (!eventsRes.ok) throw new Error(`Failed to load events: ${eventsRes.status}`);
    const events = await eventsRes.json();

    if (events.length === 0) {
      container.innerHTML = "<p>No events yet.</p>";
      return;
    }

    container.innerHTML = "";

    for (const e of events) {
      let summary = { Going: 0, Maybe: 0, Decline: 0 };
      let rsvpData = null;

      try {
        let rsvpRes = await fetch(`${API}/rsvp/event/${e._id}`, { headers: { Authorization: `Bearer ${token}` } });
        if (!rsvpRes.ok) {
          rsvpRes = await fetch(`${API}/rsvp/event/${e.id || e._id}`, { headers: { Authorization: `Bearer ${token}` } });
        }
        if (rsvpRes.ok) {
          rsvpData = await rsvpRes.json();
          summary = rsvpData.summary || summary;
        }
      } catch(err) {
        console.warn(`RSVP fetch failed for event ${e._id}:`, err);
      }

      const div = document.createElement("div");
      div.className = "event-card";
      div.innerHTML = `
        <h3>${e.title}</h3>
        <p>${e.description || ""}</p>
        <p>${new Date(e.date).toLocaleDateString()} | ${e.time} | ${e.location}</p>
        <p><strong>RSVP Summary:</strong> Going: ${summary.Going}, Maybe: ${summary.Maybe}, Decline: ${summary.Decline}</p>
        <button onclick="startEdit('${e._id}')">Edit</button>
        <button onclick="deleteEvent('${e._id}')">Delete</button>
      `;
      container.appendChild(div);
    }
  } catch(err) {
    console.error("Failed to load events:", err);
    container.innerHTML = '<p class="loading">Failed to load events. Check console.</p>';
  }
}

document.getElementById("eventForm").addEventListener("submit", async e => {
  e.preventDefault();
  const body = {
    title: document.getElementById("title").value,
    description: document.getElementById("description").value,
    date: document.getElementById("date").value,
    time: document.getElementById("time").value,
    location: document.getElementById("location").value
  };

  try {
    let res;
    if(editingEventId){
      res = await fetch(`${API}/events/${editingEventId}`, {
        method: "PUT",
        headers: { "Content-Type":"application/json", Authorization:`Bearer ${token}` },
        body: JSON.stringify(body)
      });
    } else {
      res = await fetch(`${API}/events`, {
        method: "POST",
        headers: { "Content-Type":"application/json", Authorization:`Bearer ${token}` },
        body: JSON.stringify(body)
      });
    }

    if(res.ok){
      alert(editingEventId ? "Event updated!" : "Event created!");
      resetForm();
      loadEvents();
    } else {
      const data = await res.json();
      alert(data.message || "Error saving event");
    }
  } catch(err){
    console.error(err);
    alert("Error saving event");
  }
});

function startEdit(id) {
  fetch(`${API}/events/${id}`, { headers:{ Authorization:`Bearer ${token}` } })
    .then(res => res.json())
    .then(e => {
      document.getElementById("title").value = e.title;
      document.getElementById("description").value = e.description;
      document.getElementById("date").value = e.date.split('T')[0];
      document.getElementById("time").value = e.time;
      document.getElementById("location").value = e.location;
      editingEventId = id;
      document.getElementById("submitBtn").textContent = "Update Event";
      document.getElementById("form-title").textContent = "Edit Event";
      document.getElementById("cancelEditBtn").style.display = "inline";
    })
    .catch(err => console.error("Failed to load event for edit:", err));
}

document.getElementById("cancelEditBtn").addEventListener("click", resetForm);

function resetForm() {
  editingEventId = null;
  document.getElementById("eventForm").reset();
  document.getElementById("submitBtn").textContent = "Create Event";
  document.getElementById("form-title").textContent = "Create Event";
  document.getElementById("cancelEditBtn").style.display = "none";
}

async function deleteEvent(id) {
  if(!confirm("Are you sure you want to delete this event?")) return;
  try {
    const res = await fetch(`${API}/events/${id}`, { method:"DELETE", headers:{ Authorization:`Bearer ${token}` } });
    if(res.ok) loadEvents();
    else alert("Error deleting event");
  } catch(err){
    console.error(err);
    alert("Error deleting event");
  }
}

function logout(){
  localStorage.clear();
  window.location="index.html";
}

loadEvents();
</script>
</body>
</html>
